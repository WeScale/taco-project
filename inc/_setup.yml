---
- name: check that mandatory vars are supplied
  assert:
    that:
      - vars[item] is defined
      - vars[item] != ''
    msg: "Mandatory variable '{{ item }}' missing"
  with_items:
    - tflayer
    - deploy_env
    - deploy_region
    - tfaction

- name: variable cooking
  set_fact:
    src_layer_dir: "{{ layers_dir }}/{{ tflayer }}"
    target_all_layers_dir: "{{ target_dir }}/terrabot"
    target_layer_dir: "{{ target_dir }}/terrabot/{{ tflayer }}"

- name: check that target terraform layer is found
  stat:
    path: "{{ src_layer_dir }}"
  register: src_layer_dir_scan

- name: check that target terraform layer is found
  assert:
    that:
      - src_layer_dir_scan.stat.exists
      - src_layer_dir_scan.stat.isdir
    msg: "Source layer could not be found: {{ src_layer_dir }}"

- name: create work dir
  file:
    path: "{{ target_layer_dir }}"
    state: directory

- name: check for terrabot var files
  stat:
    path: "{{ item }}"
  register: terrabot_vars_scan
  with_items:
    - "{{ playbook_dir }}/all.terrabot.yml"
    - "{{ layers_dir }}/all.terrabot.yml"
    - "{{ layers_dir }}/common.yml"
    - "{{ layers_dir }}/{{ tflayer }}/all.yml"
    - "{{ layers_dir }}/{{ tflayer }}/all.{{ deploy_region }}.yml"
    - "{{ layers_dir }}/{{ tflayer }}/{{ deploy_env }}.all.yml"
    - "{{ layers_dir }}/{{ tflayer }}/{{ deploy_env }}.{{ deploy_region }}.yml"

- name: cooking variables
  set_fact:
    tfvars_addons: >-
      {{
        terrabot_vars_scan.results
        |selectattr('stat.exists')
        |map(attribute='stat.path')
        |list
      }}

- name: generate a json tfvar file for
  include_tasks: "{{ playbook_dir }}/inc/_tfvars_addon.yml"
  with_items: "{{ tfvars_addons }}"
  loop_control:
    loop_var: "terrabot_var_file"

- name: get current_role
  shell:
    aws sts get-caller-identity --output text --query UserId | awk -F ':' '{ print $2 }'
  register: actual_role

#- sts_assume_role:
#    role_arn: "arn:aws:iam::{{ sec_account_id }}:role/{{ actual_role.stdout }}"
#    role_session_name: "{{ actual_role.stdout }}"
#    region: "{{ deploy_region }}"
#  register: kms_assume_role
#
#- name: get tfstate kms key
#  shell:
#    aws kms describe-key --key-id "alias/tfstates"
#  register: kms_key_id
#  environment:
#    AWS_ACCESS_KEY_ID: "{{ kms_assume_role.sts_creds.access_key }}"
#    AWS_SECRET_ACCESS_KEY: "{{ kms_assume_role.sts_creds.secret_key }}"
#    AWS_SESSION_TOKEN: "{{ kms_assume_role.sts_creds.session_token }}"
#    AWS_SECURITY_TOKEN: "{{ kms_assume_role.sts_creds.session_token }}"
#    AWS_DEFAULT_REGION: "{{ deploy_region }}"

- set_fact:
    var_files_options: >-
      {{
        generated_tfvars|default([])
        |map('regex_replace', '(.*)', '-var-file=\1')
        |list
      }}
